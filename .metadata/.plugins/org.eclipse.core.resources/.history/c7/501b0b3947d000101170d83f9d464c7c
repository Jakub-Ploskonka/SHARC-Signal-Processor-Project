/*********************************************************************************

 Copyright(c) 2012 Analog Devices, Inc. All Rights Reserved.

 This software is proprietary and confidential.  By using this software you agree
 to the terms of the associated Analog Devices License Agreement.

 *********************************************************************************/
// File name:
/******************************************************************************************************
/                                                                                                     /
/                            AD1939 - SPORT1 RX INTERRUPT SERVICE ROUTINE                             /
/                                                                                                     /
/    Receives input data from the AD1939 ADCs via SPORT1 and transmits processed audio data 	      /
/    back out to the four AD1939 Stereo DACs/Line Outputs through SPORT0.                             /
/                                                                                                     /
*******************************************************************************************************
/                                                                                                     /
/   This Serial Port 1 Recieve Interrupt Service Routine performs arithmetic computations on          /
/   the SPORT1 receive DMA buffer (rx1a_buf) and places results to SPORT0 transmit                    /
/   DMA buffer (tx0a_buf)                                                                             /
/                                                                                                     /
/  rx1a_buf[8] - DSP SPORT recieve buffer - AD1939                                                    /
/  Slot # Description                             DSP Data Memory Address                             /
/  ------ --------------------------------------  --------------------------------------------------  /
/  0      Internal ADC 0 Left Channel             DM(_rx1a_buf + 0) = DM(_rx1a_buf + Internal_ADC_L1) /
/  1      Internal ADC 0 Right Channel            DM(_rx1a_buf + 1) = DM(_rx1a_buf + Internal_ADC_R1) /
/  2      Internal ADC 1 Left Channel             DM(_rx1a_buf + 2) = DM(_rx1a_buf + Internal_ADC_L2) /
/  3      Internal ADC 1 Right Channel            DM(_rx1a_buf + 3) = DM(_rx1a_buf + Internal_ADC_R2) /
/  4      External Auxilliary ADC 1 Left Chan.    DM(_rx1a_buf + 4) = DM(_rx1a_buf + AUX_DAC_L1)      /
/  5      External Auxilliary ADC 1 Right Chan.   DM(_rx1a_buf + 5) = DM(_rx1a_buf + AUX_DAC_R1)      /
/  6      External Auxilliary ADC 2 Left Chan.    DM(_rx1a_buf + 6) = DM(_rx1a_buf + AUX_DAC_L2)      /
/  7      External Auxilliary ADC 2 Right Chan.   DM(_rx1a_buf + 7) = DM(_rx1a_buf + AUX_DAC_R2)      /
/                                                                                                     /
/  tx0a_buf[8] - DSP SPORT transmit buffer - AD1939                                                   /
/  Slot # Description                             DSP Data Memory Address                             /
/  ------ --------------------------------------  --------------------------------------------------  /
/  0      Internal DAC 1 Left Channel             DM(_tx0a_buf + 0) = DM(_tx0a_buf + Internal_DAC_L1) /
/  1      Internal DAC 1 Right Channel            DM(_tx0a_buf + 1) = DM(_tx0a_buf + Internal_DAC_R1) /
/  2      Internal DAC 2 Left Channel             DM(_tx0a_buf + 2) = DM(_tx0a_buf + Internal_DAC_L2) /
/  3      Internal DAC 2 Right Channel            DM(_tx0a_buf + 3) = DM(_tx0a_buf + Internal_DAC_R2) /
/  4      Internal DAC 3 Left Channel             DM(_tx0a_buf + 4) = DM(_tx0a_buf + Internal_DAC_L3) /
/  5      Internal DAC 3 Right Channel            DM(_tx0a_buf + 5) = DM(_tx0a_buf + Internal_DAC_R3) /
/  6      Internal DAC 4 Left Channel             DM(_tx0a_buf + 6) = DM(_tx0a_buf + Internal_DAC_L4) /
/  7      Internal DAC 4 Right Channel            DM(_tx0a_buf + 7) = DM(_tx0a_buf + Internal_DAC_R4) /
/                                                                                                     /
******************************************************************************************************/

//#include "adds_21479_ezkit.h"
#include <asm_sprt.h>

.section /dm seg_dmda;

.var			spint = address(_state);

.extern			_state;

#define TAPS 48


.section /pm seg_pmco ; 

_filterFIR : 
	.global _filterFIR ;
	b4=r4; l4=TAPS;  
	i12=r8;    
	//m12=1;    
	m12=2;
	// circular buffer settings and also i4=b4 
	// PM FIR coefficients address 
	// SISD version 
	//m4=-1; 
	BIT SET Mode1 0x1000000;  //circular buffer mode ON 
	nop; 
	i4= dm ( spint );   
	// Load �state� buffer current pointer 
	//r4=i4;   
	r8=i4;
	//dm (i4,1)=r12;   
	dm (i4,-1)=r12;   
	
	// save new sample in circular buffer �state� 
	dm ( spint )=i4; 
	i4=r4; m4=TAPS;
	r0= dm (i4,0);
	dm (m4,i4) = r0; // copy state[0] to first position AFTER state[] upper boundary
	BIT SET Mode1 0x0200000;   // PEYEN switch ON ( PEy unit ENable ) 
	nop;
	//mrf =0, i4=r4; 
	//r0= dm (i4,m4); 
	//r4=pm(i12,m12); 
	mrf =0, i4=r8; m4=2; 
	f8=0;f12=0;  // clear result registers 
	r0= dm (i4,m4), r4= pm (i12,m12);
	//lcntr =TAPS, do endsplot until LCE; 
	//endsplot : mrf =mrf+r0*r4( ssf ), r0= dm (i4,m4), r4=pm(i12,m12); 
	lcntr = TAPS/2 , do endsimd until LCE; 
	/*endsimd : mrf =mrf+r0*r4( ssf ), r0= dm (i4,m4), r4=pm(i12,m12);
	r0= rnd mrf (SF); 
	r4=s0; 
	r0=r0+r4; */
	endsimd: f8=f0*f4, f12=f8+f12, r0=dm(i4,m4), r4=pm(i12,m12); 
	f12=f8+f12; // last multiplication result addition 
	r4=s12; 
	f0=f4+f12; 
	
	//BIT CLR Mode1 0x1000000;  // clear CBUFF mode 
	BIT CLR Mode1 0x1200000; 
	nop ; 
	leaf_exit ; 
_filterFIR.end : 
